<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="project.bookclub.mapper.BookClubMapper">

    <!-- 독서모임 1건 조회 (상세 페이지용) -->
    <select id="selectById" parameterType="long" resultType="project.bookclub.vo.BookClubVO">
        SELECT
            book_club_seq,
            book_club_name,
            book_club_desc,
            book_club_rg,
            book_club_max_member,
            book_club_deleted_dt,
            banner_img_url,
            book_club_schedule,
            crt_dtm,
            upd_dtm,
            book_club_leader_seq
        FROM book_club
        WHERE book_club_seq = #{bookClubSeq}
          AND book_club_deleted_dt IS NULL
    </select>

    <!-- 특정 멤버가 JOINED 상태로 가입되어 있는지 확인 (count 반환) -->
    <select id="selectJoinedMemberCount" resultType="int">
        SELECT COUNT(*)
        FROM book_club_member
        WHERE book_club_seq = #{bookClubSeq}
          AND member_seq = #{memberSeq}
          AND join_st = 'JOINED'
    </select>

    <!-- 독서모임의 전체 JOINED 멤버 수 조회 -->
    <select id="getTotalJoinedMemberCount" resultType="int">
        SELECT COUNT(*)
        FROM book_club_member
        WHERE book_club_seq = #{bookClubSeq}
          AND join_st = 'JOINED'
    </select>

    <!-- 특정 멤버의 대기중인 가입 신청 확인 (request_st='WAIT') -->
    <select id="selectPendingRequestCount" resultType="int">
        SELECT COUNT(*)
        FROM book_club_request
        WHERE book_club_seq = #{bookClubSeq}
          AND request_member_seq = #{memberSeq}
          AND request_st = 'WAIT'
    </select>

    <!-- 가입 신청 INSERT -->
    <insert id="insertJoinRequest">
        INSERT INTO book_club_request (
            book_club_seq,
            request_member_seq,
            request_st,
            request_dtm,
            request_cont
        ) VALUES (
            #{bookClubSeq},
            #{memberSeq},
            'WAIT',
            CURRENT_TIMESTAMP,
            #{requestCont}
        )
    </insert>

    <!-- 독서모임의 찜 개수 조회 -->
    <select id="selectWishCount" resultType="int">
        SELECT COUNT(*)
        FROM book_club_wish
        WHERE book_club_seq = #{bookClubSeq}
    </select>

    <!-- 독서모임 게시판 - 최근 원글 10개 조회 (member_info 조인) -->
    <select id="selectRecentRootBoardsByClub" resultType="project.bookclub.vo.BookClubBoardVO">
        SELECT
            bcb.book_club_board_seq,
            bcb.book_club_seq,
            bcb.board_title,
            bcb.board_cont,
            bcb.board_img_url,
            bcb.member_seq,
            bcb.parent_book_club_board_seq,
            bcb.book_info_seq,
            bcb.board_deleted_yn,
            bcb.board_deleted_dtm,
            
            bcb.crt_dtm AS board_crt_dtm,
            bcb.upd_dtm AS board_upd_dtm,

            to_char(bcb.crt_dtm, 'YYYY-MM-DD HH24:MI') AS board_crt_dtm_text,

            m.member_nicknm

        FROM book_club_board bcb
        INNER JOIN member_info m ON bcb.member_seq = m.member_seq
        WHERE bcb.book_club_seq = #{bookClubSeq}
          AND bcb.parent_book_club_board_seq IS NULL
          AND (bcb.board_deleted_yn IS NULL OR bcb.board_deleted_yn = false)
        ORDER BY bcb.book_club_board_seq DESC
        LIMIT 10
    </select>

</mapper>
