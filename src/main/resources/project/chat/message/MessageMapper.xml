<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="project.chat.message.MessageMapper">

    <insert id="save" parameterType="project.chat.message.MessageVO">
        INSERT INTO chat_msg (
        chat_room_seq,
        trade_seq,
        sender_seq,
        chat_cont,
        sent_dtm,
        read_yn
        ) VALUES (
        #{chat_room_seq},
        #{trade_seq},
        #{sender_seq},
        #{chat_cont},
        now(),
        false
        )
    </insert>
    <!-- 메시지 읽음 처리 -->
    <update id="updateReadStatus">
        UPDATE chat_msg SET read_yn = true
        WHERE chat_room_seq = #{chat_room_seq}
        and sender_seq !=#{member_seq}
        and read_yn = false

    </update>

    <!-- 메시지 전체 조회 -->
    <select id="findByRoomSeq" resultType="project.chat.message.MessageVO">
        SELECT chat_msg_seq, chat_room_seq, sender_seq, chat_cont, sent_dtm, read_yn,
        (SELECT member_nicknm FROM member_info WHERE member_seq = chat_msg.sender_seq) AS member_seller_nicknm
        FROM chat_msg
        WHERE chat_room_seq = #{chat_room_seq}
        ORDER BY sent_dtm ASC
    </select>
    <select id="isUnreadMessage" resultType="java.lang.Boolean">
        SELECT EXISTS (
        SELECT 1
        FROM chat_msg
        WHERE read_yn = 'N'
        )s
    </select>

    <!-- 닉네임 조회 -->
    <select id="findBySellerNicknm" resultType="java.lang.String">
        SELECT member_nicknm AS member_seller_nicknm
        FROM member_info WHERE member_seq = #{member_seq}
    </select>

</mapper>